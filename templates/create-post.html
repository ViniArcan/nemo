{% extends './partials/base_layout.html' %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/separador.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/post-summary.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/generic-pages.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/create-post.css') }}">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKLCeC//c2oV2v5KZZB3r3RaTRoQBCQBibUTmH6exPs" crossorigin="anonymous">

<style>
    /* Styles for the side-by-side layout */
    .editor-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    .editor-form, .editor-preview {
        flex: 1;
        width: 50%;
    }

    /* --- ADD THESE NEW RULES --- */
    .editor-form p:first-child, .editor-preview h2 {
        margin-top: 0;
    }
    /* -------------------------- */

</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/shorten-paragraphs-inside-posts.js') }}"></script>

<script src="https://unpkg.com/showdown/dist/showdown.min.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmloGiJTAo" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

<script>
    var converter = new showdown.Converter();

    function updatePreview() {
        // Step 1: Convert the whole text from Markdown to HTML
        var markdownText = document.getElementById('txt-content').value;
        var preview = document.getElementById('conteudo-post');
        preview.innerHTML = converter.makeHtml(markdownText);

        // Step 2: Find and render any LaTeX math inside the generated HTML
        renderMathInElement(preview, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ]
        });
        
        // This was in your original file, so we keep it
        if (typeof update_renderings === 'function') {
            update_renderings();
        }
    }

    function submitForm(event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('post-title', document.getElementById('inp-post-title').value);
        formData.append('post-desc', document.getElementById('txt-desc').value);
        formData.append('post-content', document.getElementById('txt-content').value);
        formData.append('post-tags', document.getElementById('txt-tags').value);
        formData.append('image', document.getElementById('image').files[0]);

        fetch('/create-post', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                // Redirect to the post page after successful creation
                window.location.href = '/post/' + data.post_id;
            })
            .catch(error => {
                console.error('Erro:', error);
            });
    }
</script>
{% endblock %}


{% block content %}

<div class="div-separadora">
    <h1>Criação de posts</h1>
</div>

<div class="central-content">

    <div class="editor-container">

        <div class="editor-form">
            <form id="create-post-form" method="post" onsubmit="submitForm(event)" enctype="multipart/form-data">
                <p>Título</p>
                <input type="text" name="post-title" id="inp-post-title">
                <p>Descrição</p>
                <textarea name="post-desc" id="txt-desc"></textarea>
                <p>Conteúdo</p>
                <textarea name="post-content" id="txt-content" oninput="updatePreview()"></textarea>
                <small>Use <code>$...$</code> for inline math and <code>$$...$$</code> for block math.</small>
                <p>Tags por linha</p>
                <textarea name="post-tags" id="txt-tags"></textarea>
                <br>
                <label for="image">Image:</label><br>
                <input type="file" id="image" name="image"><br>
                <input type="submit" value="Criar post">
            </form>
        </div>

        <div class="editor-preview">
            <h2>Preview</h2>
            <div id="conteudo-post" style="border: 1px solid #ccc; padding: 10px; min-height: 400px;">
                </div>
        </div>

    </div>

</div>

{% endblock %}